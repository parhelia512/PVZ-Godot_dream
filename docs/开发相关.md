
# 植物僵尸动画
使用[R2Ga_PVZ](#r2ga_pvz)将植物大战僵尸的动画文件转换为Godot游戏引擎所支持的动画格式。

僵尸动画：使用插件[anim_player_refactor](#anim_player_refactor)删除一些轨道，主要是删除删除僵尸胳膊和头相关的visible轨道，僵尸掉手或掉头时使用代码控制visible。

植物动画：植物射击时眨眼和idle时眨眼节点不同，由于射击时眨眼动画需要使用visible轨道，使用插件[anim_player_refactor](#anim_player_refactor)将idle时的眨眼节点visible轨道删除，使用代码控制植物眨眼。


# 子弹攻击碎片溅射
- 创建GPUParticles2D
- texture(GPUParticles2D) 添加子弹碎片图集
- material(CnavasItem) 添加CanvasItemMaterial
	- 修改对应的articles_anim_h_frames和particles_anim_v_frames
- process_material(GPUParticles2D) 添加ParticleProcessMaterial
	- 修改Display-Animation-Offset
- 修改粒子特效相关属性（初始方向，重力加速度，时间缩放）

# 碰撞相关
## 碰撞层说明
- layer 1 World : 世界层，房子区域泳池碰撞使用该层
- layer 2 Plant : 植物层，植物所在层
- layer 3 Zombie : 僵尸层，僵尸本体所在层，
- layer 4 Bullet : 子弹层，子弹所在层，
- layer 5 ZombieInAttack : 僵尸攻击碰撞时受击碰撞箱所在层,不攻击时和本体受击碰撞箱重叠,攻击时向前移动,特殊植物可以检测(倭瓜\大嘴花)
- layer 6 ZombieBeHypnotized : 僵尸被魅惑层，被魅惑僵尸改变至该层，植物子弹检测不到，
- layer 7 Bowling : 保龄球子弹层，撑杆跳僵尸可以检测到该层跳跃，
- layer 8 UpBullet : 升级子弹区域所在层

## 碰撞检测
检测碰撞时会同时检测角色受击状态
  若可以检测者可以检测到目标受击状态,发射可以攻击信号
  若不能攻击,连接僵尸状态改变信号,僵尸状态改变时,重新判断是否可以攻击

植物:
```gd
enum E_BeAttackStatusPlant{
	IsNorm = 1,		## 正常
	IsFloat = 2,	## 悬浮
	IsDown = 4, 	## 地刺
}
```
僵尸:
```
enum E_BeAttackStatusZombie{
	IsNorm = 1,		## 正常
	IsJump = 2,		## 跳跃
	IsDownPool = 4,		## 水下
	IsSky = 8,			## 空中
	IsDownGround = 16,	## 地下
	IsJumpInPool = 32,	## 跳入泳池,该状态无法被高建国拦截
}
```


# 植物种植相关
植物位置有四种: `float(漂浮植物:咖啡豆)、down(底部植物:花盆、睡莲)、norm(正常普通植物：豌豆射手)、shell(壳类植物：南瓜头)`
地形分为6种（植物格子为某一种类型+“无”类型）：`"1 无", "2 草地", "4 花盆", "8 水", "16 睡莲", "32 屋顶/裸地"`

植物种植的地形可以为多种，如豌豆射手：`22 = 2(草地) + 4(花盆)+ 16(睡莲)`
植物的位置属性只能选一种
每个植物的种植条件使用自定义资源（`ResourcePlantCondition`），相同的种植条件可以使用同一个资源
种植条件资源需要保存在`res://resources/plant_resource/plant_condition/`目录下


植物格子（`PlantCell类`）管理当前格子的植物
普通植物种植时需同时满足当前植物格子空闲位置和地形才可以种植
特殊植物需继承种植资源脚本重写判断函数判断是否可以种植

植物格子有每个位置对应的植物容器作为种植植物的父节点
原始PlantCell节点如下：
- PlantCell (PlantCell)
  - PlantDownContainer (Node2d)
  - PlantFloatContainer (Node2d)
  - PlantNormContainer (Node2d)
  - PlantShellContainer (Node2d)

本项目norm和shell位置的植物可以跟随down的植物上下移动（原版花盆种植植物后就不动了，我写完才发现，就这样了）
down位置植物需要容器节点（DownPlantSelfContainer）作为norm和shell位置植物的父节点，down位置植物移动容器节点从而带动norm和shell位置植物移动（使用动画或tween控制移动）
种植down位置植物时将植物格子的norm和shell位置的容器节点作为down位置植物的容器节点的子节点。
down位置植物节点如下：
- DownPlant(Plant)
	- DownPlantSelfContainer(Node2D)
	- DownPlantOtherNode

种植底部植物后如下所示
- PlantCell (PlantCell)
  - PlantDownContainer (Node2d)
	- DownPlant(Plant)
		- DownPlantSelfContainer(Node2D)
			- DownPlantOtherNode
			- PlantFloatContainer (Node2d)
			- PlantNormContainer (Node2d)
  - PlantShellContainer (Node2d)


## 可能踩的坑
- 1、植物需要对应的种植条件资源文件，需要在global脚本中更新对应的PlantInfo
- 2、静态迷雾_ready()函数中会调用init_static_fog()初始化静态迷雾，会删除`
@export var del_fog_postion_area:Vector2 = Vector2(650, 700)`之外的静态迷雾,如果修改屏幕显示大小，需修改该参数适应屏幕

# <mark>创建新角色(植物\僵尸)</mark>
- 角色场景都是继承的`res://scenes/character/character_000_base.tscn`场景
- - 植物场景继承`res://scenes/character/plant/plant_000_base.tscn`,
底部植物改变地形,继承`res://scenes/character/plant/plant_000_down_base.tscn`
- - 僵尸场景继承`res://scenes/character/zombie/zombie_000_base.tscn`.
- 新建角色场景后,修改对应角色类型(`plant_type`\\`zombie_type`)

## 新僵尸
从`res://scenes/character/zombie/zombie_000_base.tscn`新建继承角色
<mark>高亮部分为每个僵尸都必须修改的节点</mark>
### <mark>动画调用轨道:</mark>
- 移动的动画开头要添加方法调用:`MoveComponent._walking_start()`
- 死亡动画结尾添加方法调用:`Zombie000Base._fade_and_remove()`
- 攻击动画攻击时添加方法调用:`AttackComponent.attack_once()`
- 在不移动的动画中将ground的position轨道删除,使用AnimationTree控制动画切换,将`deterministic`属性设为false,过度动画不会混合ground的position轨道
- 根据groud节点移动的僵尸在僵尸每次动画结束时发射animation_finished信号会设置停止移动,下一个动画若为移动动画且有过度时间,第一次移动动画会停止移动,将前一个动画设置为循环(不发射animation_finished信号),设置动画过度属性`break_loop_at_end = true`

### 影子(Shadow):
- 僵尸影子
### <mark>身体(Body):</mark>
- 僵尸身体,将僵尸的精灵节点全都放在`BodyCorrect`节点下,移动`BodyCorrect`节点,修正位置,Body节点位置默认为(0,0),在修改角色大小时,不需要移动Body位置
- 存放掉落的头\手\防具,对应掉落时激活掉落物，文件夹作用，可以不放在在节点下,`ZombieDropBase`类节点位置要为Vec(0,0),其子节点位置为对应body位置
### <mark>血量阶段变化组件(HpStageChangeComponent):</mark>
- 更新本体\防具血量临界值
- 默认每三分之一到下一阶段
- 1. 本体血量默认2个临界值,需要在body_change列表中添加两个对应掉手和掉头的资源文件
- 2. 防具血量默认3个临界值,需要在body_change_armor中添加3个对应的防具状态变化资源文件
### <mark>血量组件(HpComponent):</mark>
- 更新僵尸本体血量\防具血量
### <mark>灰烬组件(CharredComponent):</mark>
- 将对应灰烬动画放到该节点的位置修正节点下(通用灰烬动画直接复制即可)
### 攻击组件(AttackComponent):
- 通用攻击组件,每帧攻击植物掉血
### 移动组件(MoveComponent):
- 根据移动方式,选择`move_mode`为`groun`或`speed`
### 游泳碰撞盒组件(SwimBoxComponet):
- 检测僵尸是否碰撞到泳池,触发僵尸游泳
### 受击碰撞盒组件(BeAttackBoxComponet):
- 增加攻击时受击碰撞盒，攻击时将攻击时受击碰撞盒向前移动，部分特殊植物（大嘴花、窝瓜）可以检测到
### 掉落物品组件(DropItemComponent):
- 死亡时判断是否掉落物品(金银钻石\花园植物)


# 卡片
所有的卡片在all_card场景中,自动加载（AllCard）  
游戏创建卡片时从AllCard中复制对应的卡片  
创建备选卡槽卡片时，使用CardInBeCard场景文件传入参数（Card）创建，

# 角色（植物和僵尸）
角色（植物和僵尸）根节点只处理基础属性、动画、body相关以及部分特殊角色功能(简单\与角色本体高度耦合不好拆分的)(土豆类准备\大嘴花攻击\魅惑)，其余全都由组件(攻击\攻击检测\移动\睡眠等基础组件)完成
信号连接必须要在角色本体中连接,除非为依赖组件(攻击行为组件与攻击检测组件)


**角色`_ready()`函数中固定根据初始化类型不同进行不同的初始化，继承的植物和僵尸不重写`_ready()`函数，而是重写`init_norm()`函数进行初始化**

角色在`add_child()`添加到节点树之前,使用init_*()函数对角色相关参数(行\初始化类型等)赋值
创建僵尸统一使用ZombieManager的create_norm_zombie()函数创建
部分主游戏全局使用的数据(植物格子\僵尸行等)放在自动加载单例MainGameDate中,每次加载主游戏场景时由对应子管理器更新赋值


## 组件信号连接
为避免信号漫天飞的情况，规定角色及其组件信号连接必需遵循以下规则（角色类的信号）：
- 角色类本身的Timer节点的timeout信号可以在编辑器中直接连接信号，组件自身的Timer信号必须连接至该组件本体节点
- 组件自定义信号父节点可以连接子节点的信号，如：
  - 攻击组件（父） 攻击检测组件（子）
- 角色速度影响的组件，在角色根节点属性中添加该组件，在角色信号连接函数中连接信号
- 组件影响组件禁用相关的，在禁用发起组件（睡眠组件、胆小组件）中添加影响组件，在角色信号连接函数中连接信号
- 除上述情况以外，其余所有自定义信号都必须由角色本体在_ready()中对应的初始化函数中连接信号

__正常出战(Norm)角色死亡必须通过血量组件掉血死亡,禁止直接删除角色__


# 插件
## [anim_player_refactor](https://github.com/poohcom1/godot-animation-player-refactor)
一个 Godot 插件，用于重构 AnimationPlayer 的动画。
[插件使用教程](https://www.bilibili.com/video/BV1GxXWYZExH?spm_id_from=333.788.videopod.sections&vd_source=1005534986b111b7c1911fe1c36ac835)

注意：目录下**plugin.gd**脚本中调用的函数EditorUtil.find_animation_menu_button(base_control)只支持英文，需要进入函数修改对应的代码 func(node): return node.text == "Animation" 修改为 func(node): return node.text == "Animation" or node.text == "动画"

## [R2Ga_PVZ](https://github.com/hsk-dream/PVZ_reanim2godot_animation)
将植物大战僵尸的动画文件转换为Godot游戏引擎所支持的动画格式。[使用教程](https://www.bilibili.com/video/BV1XBKwzdELA/)
forked from [PVZ_reanim2godot_animation](https://github.com/HYTommm/PVZ_reanim2godot_animation)
